<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AP Chem QOTD</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/topbar.css">
  <link rel="stylesheet" href="css/bottombar.css">
  <style>
    .qotd-header { text-align: center; margin-top: 32px; margin-bottom: 12px; }
    .qotd-subheader { text-align: center; font-size: 1.25rem; font-weight: 500; color: var(--heading-color, #3949ab); margin-bottom: 24px; }
    .qotd-layout { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 32px; margin-bottom: 36px; flex-wrap: wrap; }
    .qotd-stats-box { flex: 0 0 320px; background: var(--box-bg, #f7f7fc); border-radius: 12px; box-shadow: 0 2px 8px rgba(44,49,83,0.09); padding: 1.5rem 1rem; margin-top: 16px; }
    .qotd-question-box { flex: 0 0 420px; background: var(--box-bg, #fff); border-radius: 12px; box-shadow: 0 2px 8px rgba(44,49,83,0.09); padding: 2rem 1.5rem; margin-left: 24px; margin-top: 0; position: relative; }
    .qotd-streak-icon-container { position: absolute; top: 12px; right: 50%; transform: translateX(50%); display: flex; flex-direction: column; align-items: center; z-index: 2; }
    #qotdStreak { font-size: 1.4rem; font-weight: 600; color: #e65100; display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; }
    #streakTooltip { position: absolute; top: -38px; left: 50%; transform: translateX(-50%); background: #fffbe9; color: #e65100; border-radius: 7px; padding: 4px 12px; font-size: 1rem; font-weight: 500; box-shadow: 0 2px 8px rgba(44,49,83,0.09); opacity: 0; pointer-events: none; transition: opacity 0.2s; white-space: nowrap; z-index: 10; }
    @media (max-width: 900px) { .qotd-layout { flex-direction: column; align-items: center; gap: 18px; } .qotd-stats-box, .qotd-question-box { margin-left: 0; width: 96vw; max-width: 420px; } .qotd-streak-icon-container { right: 50%; } }
    .leaderboard-section { margin: 0 auto; max-width: 700px; background: var(--box-bg, #fff); border-radius: 12px; box-shadow: 0 2px 8px rgba(44,49,83,0.09); padding: 2rem 1.5rem; }
    .leaderboard-tabs { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 18px; }
    .leaderboard-tab { padding: 0.6em 1.8em; background: var(--tab-bg, #e3e6fa); color: var(--tab-text, #3949ab); border: none; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 1.08rem; cursor: pointer; transition: background 0.2s, color 0.2s; outline: none; }
    .leaderboard-tab.active { background: var(--tab-active-bg, #3949ab); color: var(--tab-active-text, #fff); }
    .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .leaderboard-table th, .leaderboard-table td { padding: 0.8em 0.5em; text-align: left; font-size: 1rem; border-bottom: 1px solid #e3e6fa; }
    .leaderboard-table th { color: var(--tab-text, #3949ab); font-weight: 700; background: #f4f6fd; }
    .leaderboard-table tr:first-child td { font-weight: bold; color: var(--accent, #43a047); }
    .leaderboard-table tr:nth-child(even) { background: #f7f8fd; }
    .leaderboard-table tr:last-child td { border-bottom: none; }
  </style>
</head>
<body>
  <div id="topbar-container"></div>
  <div id="sidebar-container"></div>
  <main>
    <div class="qotd-header">
      <h2>AP Chem Question of the Day</h2>
      <div class="qotd-subheader">
        Welcome to the AP Chem Question of the Day Challenge! Try the daily question, check your stats, and climb the leaderboard.
      </div>
    </div>
    <div class="qotd-layout">
      <div class="qotd-stats-box" id="qotdStatsBox">
        <h3>Your Stats</h3>
        <ul style="list-style:none; padding:0; margin-top:14px;">
          <li><strong>Total Correct:</strong> <span id="statsTotalCorrect">--</span></li>
          <li><strong>Current Streak:</strong> <span id="statsCurrentStreak">--</span></li>
          <li><strong>Best Streak:</strong> <span id="statsLongestStreak">--</span></li>
          <li><strong>Percent Correct:</strong> <span id="statsPercentCorrect">--</span></li>
        </ul>
        <div id="statsErrorMsg" style="color:#c00; margin-top:10px; display:none;"></div>
        <div id="qotdBlurOverlay" class="qotd-blur-overlay" style="display:none;">
          <button id="qotdSignInBtn" class="sign-in-btn">Sign In to Answer</button>
        </div>
      </div>
      <div class="qotd-question-box" id="qotdQuestionBox">
        <div class="qotd-streak-icon-container">
          <div id="qotdStreak"></div>
          <div id="streakTooltip" style="display:none;"></div>
        </div>
        <h3>Today's Question</h3>
        <div id="qotdQuestionContent"></div>
      </div>
    </div>
    <div class="leaderboard-section">
      <div class="leaderboard-tabs">
        <button class="leaderboard-tab active" id="tabTotalCorrect">Top Total Correct</button>
        <button class="leaderboard-tab" id="tabStreak">Top Streak</button>
        <button class="leaderboard-tab" id="tabPercentCorrect">Top % Correct</button>
      </div>
      <div id="leaderboardContent">
        <table class="leaderboard-table" id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th id="leaderboardMetricHeader">Total Correct</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </main>
  <div id="indexBottomBar" class="bottom-bar">
    <div class="bottom-bar-left" id="bottomBarLeft"></div>
    <div class="bottom-bar-center">
      <button id="returnHomeBtn" onclick="window.location.href='index.html'">Return to Home</button>
    </div>
    <div class="bottom-bar-right">
      <button id="futureFeatureBtn" disabled>Future Feature</button>
    </div>
  </div>

  <div id="auth-modal-container"></div>
  <div id="confettiOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; z-index:2000;"></div>
  <div id="username-modal-container"></div>

  <script type="module">
    // ---------- Shared imports ----------
    import { loadTopbar } from './js/topbar.js';
    import { loadSidebar } from './js/sidebar.js';
    import {
      onAuthChange,
      setupAuthModalEvents,
      ensureUsernameOnLogin,
      updateUnitBottomBarAuthButtons,
      db // <-- Make sure db is imported here!
    } from './js/auth.js';
    import { setupUsernameModal } from './js/username-modal.js';
    import { toggleTheme, applySavedTheme } from './js/theme-toggle.js';
    import { loadQOTD, renderUserStreakAlways, updateStatsBox } from './js/qotd.js';
    import { setupLeaderboardTabs, loadLeaderboard } from './js/leaderboard.js';

    // ---------- Modal loader functions ----------
    async function loadAuthModal() {
      const resp = await fetch('auth-modal.html');
      const html = await resp.text();
      document.body.insertAdjacentHTML('beforeend', html);
    }
    async function loadUsernameModal() {
      const resp = await fetch('username-modal.html');
      const html = await resp.text();
      document.body.insertAdjacentHTML('beforeend', html);
    }

    // ---------- DOM Ready setup ----------
    document.addEventListener("DOMContentLoaded", async () => {
      await loadAuthModal();
      await loadUsernameModal();
      setupAuthModalEvents();
      setupUsernameModal();

      loadTopbar("Question of the Day");
      loadSidebar();
      applySavedTheme();

      // QOTD logic
      await loadQOTD();
      renderUserStreakAlways();
      updateStatsBox();

      // Leaderboard setup - FIXED: pass db!
      setupLeaderboardTabs((metric) => loadLeaderboard(metric, db));
      loadLeaderboard("total", db);

      // Bottom bar auth logic
      updateUnitBottomBarAuthButtons();
    });

    // ---------- Auth Change Event for Stats & Streak ----------
    onAuthChange(async user => {
      await ensureUsernameOnLogin();
      updateUnitBottomBarAuthButtons();
      renderUserStreakAlways();
      updateStatsBox();
    });
  </script>
</body>
</html>
