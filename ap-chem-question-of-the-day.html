<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AP Chem QOTD</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/topbar.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/bottombar.css">
  <link rel="stylesheet" href="css/qotd.css">
</head>
<body>
  <div id="topbar-container"></div>
  <div id="sidebar-container"></div>
  <main>
   <div class="container">
  <div class="box">
    <h2>AP Chem Question of the Day</h2>
    <div class="qotd-subheader">
      Welcome to the AP Chem Question of the Day Challenge! Try the daily question, check your stats, and climb the leaderboard.
    </div>
  </div>
</div>
    <div class="qotd-layout">
      <div class="qotd-stats-box" id="qotdStatsBox">
        <h3>Your Stats</h3>
        <hr>
        <ul style="list-style:none; padding:0; margin-top:14px;">
          <li><strong>Total Correct:</strong> <span id="statsTotalCorrect">--</span></li>
          <li><strong>Current Streak:</strong> <span id="statsCurrentStreak">--</span></li>
          <li><strong>Best Streak:</strong> <span id="statsLongestStreak">--</span></li>
          <li><strong>Percent Correct:</strong> <span id="statsPercentCorrect">--</span></li>
        </ul>
        <div id="statsErrorMsg" style="color:#c00; margin-top:10px; display:none;"></div>
      </div>
      <div class="qotd-question-box" id="qotdQuestionBox">
        <div id="qotdBlurOverlay" class="qotd-blur-overlay" style="display:none;">
          <button id="qotdSignInBtn" class="sign-in-btn">Sign In to Answer</button>
        </div>
        <div class="qotd-streak-icon-container">
          <div id="qotdStreak"></div>
          <div id="streakTooltip" style="display:none;"></div>
        </div>
        <h3>Today's Question</h3>
        <hr>
        <div id="qotdQuestionContent"></div>
      </div>
    </div>
    <div class="leaderboard-section">
      <h2>AP Chem Question of the Day Leaderboard</h2>
      <hr>
      <div class="leaderboard-tabs">
        <button class="leaderboard-tab active" id="tabTotalCorrect">Top Total Correct</button>
        <button class="leaderboard-tab" id="tabStreak">Top Streak</button>
        <button class="leaderboard-tab" id="tabPercentCorrect">Top % Correct</button>
      </div>
      <div id="leaderboardContent">
        <table class="leaderboard-table" id="leaderboardTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th id="leaderboardMetricHeader">Total Correct</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </main>
  <div id="indexBottomBar" class="bottom-bar">
  <div class="bottom-bar-left" id="bottomBarLeft"></div>
  <div class="bottom-bar-center">
    <button id="returnHomeBtn" onclick="window.location.href='ap-chem-course-guide.html'">Return to Home</button>
  </div>
  <div class="bottom-bar-right">
    <button id="futureFeatureBtn" onclick="window.open('https://forms.gle/CTyDuLatR2WVnKLs9', '_blank')">Future Feature (Premium Content Waitlist)</button>
  </div>
</div>
<!-- Footer text, FULL WIDTH, BELOW the button bar -->
<div class="footer-info">
  <a href="about.html">Contact/About</a>
  <span class="footer-dot">&middot;</span>
  <span>AP Prep Hub <sup class="tm-symbol">&#8482;</sup></span>
  <span class="footer-copyright">&copy; 2024 AP Prep Hub</span>
</div>

  <div id="auth-modal-container"></div>
  <div id="confettiOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; pointer-events:none; z-index:2000;"></div>
  <div id="username-modal-container"></div>

  <script type="module">
    // ---------- Shared imports ----------
    import { loadTopbar } from './js/topbar.js';
    import { loadSidebar } from './js/sidebar.js';
    import {
      onAuthChange,
      setupAuthModalEvents,
      ensureUsernameOnLogin,
      updateUnitBottomBarAuthButtons,
      db // <-- Make sure db is imported here!
    } from './js/auth.js';
    import { toggleTheme, applySavedTheme } from './js/theme-toggle.js';
    window.toggleTheme = toggleTheme;
    import { setupUsernameModal } from './js/username-modal.js';
    import { loadQOTD, renderUserStreakAlways, updateStatsBox } from './js/qotd.js';
    import { setupLeaderboardTabs, loadLeaderboard } from './js/leaderboard.js';
    import { injectAccountModal, setupAccountModalEvents } from './js/account-modal.js';

    // ---------- Modal loader functions ----------
    async function loadAuthModal() {
      const resp = await fetch('auth-modal.html');
      const html = await resp.text();
      document.body.insertAdjacentHTML('beforeend', html);
    }
    async function loadUsernameModal() {
      const resp = await fetch('username-modal.html');
      const html = await resp.text();
      document.body.insertAdjacentHTML('beforeend', html);
    }

    // ---------- DOM Ready setup ----------
    document.addEventListener("DOMContentLoaded", async () => {
      await loadAuthModal();           // 1. Inject HTML for Auth modal
  setupAuthModalEvents();          // 2. Setup events for Auth modal

  await loadUsernameModal();       // 3. Inject HTML for Username modal
  setupUsernameModal();            // 4. Setup events for Username modal

  await injectAccountModal();      // 5. Inject HTML for Account modal
  setupAccountModalEvents();       // 6. Setup events for Account modal
      loadTopbar("Question of the Day");
      loadSidebar();
      applySavedTheme();

      // QOTD logic
      await loadQOTD();
      renderUserStreakAlways();
      updateStatsBox();

      // Leaderboard setup - FIXED: pass db!
      setupLeaderboardTabs((metric) => loadLeaderboard(metric, db));
      loadLeaderboard("total", db);

      // Bottom bar auth logic
      updateUnitBottomBarAuthButtons();
    });

    // ---------- Auth Change Event for Stats & Streak ----------
    onAuthChange(async user => {
      // Only show username modal for Google sign-in
  if (user && user.providerData.some(p => p.providerId === "google.com")) {
    await ensureUsernameOnLogin();
  }
      updateUnitBottomBarAuthButtons();
      renderUserStreakAlways();
      updateStatsBox();
      loadLeaderboard("total", db);
    });
  </script>
</body>
</html>
